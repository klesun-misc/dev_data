<head>
    <script src="./common/js/Tls.js"></script>
    <script src="./common/js/VarExportParser.js"></script>
    <script src="./common/js/acejs/ace.js" type="text/javascript" charset="utf-8"></script>
</head>

<body>
Enter your text here:<br/>
<div id="describeInput"></div><br/>
<div id="buttonsCont"></div>
<label>var_export inline limit<input type="number" class="var-export-inline-limit" value="110"/></label>

<script type="module">

    import {parsePrintRValue, printRExample, varExportExample} from "./common/js/PhpTools.js";
    import {parseSqlSelectG, someSqlSelect, someSqlSelectG, sqlSelectToJson} from "./common/js/SqlTools.js";
    import {csvToJson, jsonToCsv, parseCsvTabs} from "./common/js/CsvTools.js";

    var $$ = s => [...document.querySelectorAll(s)];

    let hashData = {};
    let hashStr = window.location.hash.substr(1);
    for (let pair of hashStr.split('&')) {
        let [key, value] = pair.split('=');
        hashData[key] = value;
    }
    window.onhashchange = () => window.location.reload();

    const getInlineLimit = () => $$('.var-export-inline-limit')[0].value;

    const applyToEachLine = (regex, out, text) =>
        text.split('\n').map(l => l.replace(regex, out)).join('\n');

    const textToWrappedLinesDoubleQuoted = function(text)
    {
        return '' +
            '[\n' + text
            .split('\n')
//			.filter(l => l !== '')
            // TODO: escape properly. for now i don't handle when string is already escaped
            .map(l => l.replace(/\$/g, '\\$'))
            .map(l => l.replace(/"/g, '\\"'))
            .map(l => '    "' + l + '",')
            .join('\n') +
            '\n].join("\\n")';
    };

    const textToWrappedLinesSingleQuoted = function(text)
    {
        text = text.replace(/\n$/, '');
        return '' +
            '[\n' + text
            .split('\n')
//			.filter(l => l !== '')
            // TODO: escape properly. for now i don't handle when string is already escaped
            .map(l => l.replace(/'/g, "\\'"))
            .map(l => "    '" + l + "',")
            .join('\n') +
            '\n].join(\'\\n\')';
    };

    var someMultilineText = [
        '     *****  AIR  HISTORY  *****',
        'XS UA 126 T20SEP IADDUB SS/HK2  1020P 1025A *',
        'XS LH 416 L21JUN FRAIAD HK/HX2  1045A  125P *',
        'XS LH 595 L20JUN PHCFRA HK/HX2   800P  535A *',
        'RCVD-VERONICA/ZDYB6A  -CR- QSB/2CV4/1V AG 6A 04JUN1719Z',
        'SC LH 416 L21JUN FRAIAD HK/HX2  1045A  125P *',
        'SC LH 595 L20JUN PHCFRA HK/HX2   800P  535A *',
        'RCVD-040004//17CF0584/ NO ID  -CR- MUC/2CV4/UA RM 1A 04JUN0004Z',
        'HS UA 126 T20SEP IADDUB SS/HK2  1020P 1025A *',
        'HS LH 416 L21JUN FRAIAD SS/HK2  1045A  125P *       1',
        'HS LH 595 L20JUN PHCFRA SS/HK2   800P  535A *       1',
        'RCVD-VERONICA/ZDYB6A  -CR- QSB/2CV4/1V AG 6A 02JUN1632Z',
    ].join('\n');

    let someWrappingMultiLineCode = [
        "        '(?P<departureCity>[A-Z]{3}) ',",
        "        '(',",
        "            '(?P<airline>[A-Z0-9]{2}) ',",
        "            '(?P<stopoverMark>X\/)?',",
        "            '(?P<city>[A-Z]{3})',",
        "            '(',",
        "                '( ',",
        "                    '(?P<fareLetter>[A-Z])( [A-Z]{6})',",
        "                    '(?P<fareAmount>\d+(\.\d+)?)',",
        "                ' ?)?',",
        "                '',",
        "            ')?',",
        "        ')+',",
        "        '(NUC(?P<nucAmount>)\d+(\.\d+)?)?',",
        "        'END',",
        "        '( ROE',",
        "            '(?P<roeAmount>\d+(\.\d+)?) ?',",
        "            '(',",
        "                '(?P<taxCode>[A-Z0-9]{2})',",
        "                '(?P<taxCity>[A-Z]{3})',",
        "                '(?P<taxAmount>\d+(\.\d+)?)',",
        "            ')*',",
        "        ')?',",
    ].join('\n');

    let fixedWidthCharMapping = {
        '0':  65296, // '０'
        '1':  65297, // '１'
        '2':  65298, // '２'
        '3':  65299, // '３'
        '4':  65300, // '４'
        '5':  65301, // '５'
        '6':  65302, // '６'
        '7':  65303, // '７'
        '8':  65304, // '８'
        '9':  65305, // '９'
        ' ':   8193, //  '
        '!':  65281, // '！'
        '"':  65282, // '＂'
        '#':  65283, // '＃'
        '$':  65284, // '＄'
        '%':  65285, // '％'
        '&':  65286, // '＆'
        '\'': 65287, // '＇'
        '(':  65288, // '（'
        ')':  65289, // '）'
        '*':  65290, // '＊'
        '+':  65291, // '＋'
        ',':  65292, // '，'
        '-':  65293, // '－'
        '.':  65294, // '．'
        '/':  65295, // '／'
        ':':  65306, // '：'
        ';':  65307, // '；'
        '<':  65308, // '＜'
        '=':  65309, // '＝'
        '>':  65310, // '＞'
        '?':  65311, // '？'
        '@':  65312, // '＠'
        'A':  65313, // 'Ａ'
        'B':  65314, // 'Ｂ'
        'C':  65315, // 'Ｃ'
        'D':  65316, // 'Ｄ'
        'E':  65317, // 'Ｅ'
        'F':  65318, // 'Ｆ'
        'G':  65319, // 'Ｇ'
        'H':  65320, // 'Ｈ'
        'I':  65321, // 'Ｉ'
        'J':  65322, // 'Ｊ'
        'K':  65323, // 'Ｋ'
        'L':  65324, // 'Ｌ'
        'M':  65325, // 'Ｍ'
        'N':  65326, // 'Ｎ'
        'O':  65327, // 'Ｏ'
        'P':  65328, // 'Ｐ'
        'Q':  65329, // 'Ｑ'
        'R':  65330, // 'Ｒ'
        'S':  65331, // 'Ｓ'
        'T':  65332, // 'Ｔ'
        'U':  65333, // 'Ｕ'
        'V':  65334, // 'Ｖ'
        'W':  65335, // 'Ｗ'
        'X':  65336, // 'Ｘ'
        'Y':  65337, // 'Ｙ'
        'Z':  65338, // 'Ｚ'
        '[':  65339, // '［'
        '\\': 65340, //  '＼'
        ']':  65341, // '］'
        '^':  65342, // '＾'
        '_':  65343, // '＿'
        '`':  65344, // '｀'
        'a':  65345, // 'ａ'
        'b':  65346, // 'ｂ'
        'c':  65347, // 'ｃ'
        'd':  65348, // 'ｄ'
        'e':  65349, // 'ｅ'
        'f':  65350, // 'ｆ'
        'g':  65351, // 'ｇ'
        'h':  65352, // 'ｈ'
        'i':  65353, // 'ｉ'
        'j':  65354, // 'ｊ'
        'k':  65355, // 'ｋ'
        'l':  65356, // 'ｌ'
        'm':  65357, // 'ｍ'
        'n':  65358, // 'ｎ'
        'o':  65359, // 'ｏ'
        'p':  65360, // 'ｐ'
        'q':  65361, // 'ｑ'
        'r':  65362, // 'ｒ'
        's':  65363, // 'ｓ'
        't':  65364, // 'ｔ'
        'u':  65365, // 'ｕ'
        'v':  65366, // 'ｖ'
        'w':  65367, // 'ｗ'
        'x':  65368, // 'ｘ'
        'y':  65369, // 'ｙ'
        'z':  65370, // 'ｚ'
        '{':  65371, // '｛'
        '|':  65372, // '｜'
        '}':  65373, // '｝'
        '~':  65374, // '～'
    };

    let dynLogsSample = `{"dt":1565084689,"dt_micro":"15650846890139000","hst":"ap01prtr.dyninno.net","msg":"TODO: Processing HTTP RQ \\/terminal\\/getPqItinerary","obj":"{\\n    \\"rqBody\\": {\\n        \\"1\\": \\"\\",\\n        \\"pqTravelRequestId\\": \\"10591900\\",\\n        \\"gds\\": \\"galileo\\",\\n        \\"travelRequestId\\": \\"10591900\\"\\n    },\\n    \\"protocol\\": \\"http\\"\\n}"}
{"dt":1565084689,"dt_micro":"15650846890190000","hst":"ap01prtr.dyninno.net","msg":"XML RQ: >*R;","obj":"<?xml version=\\"1.0\\" encoding=\\"UTF-8\\"?>\\n\\t<SOAP-ENV:Envelope xmlns:SOAP-ENV=\\"http:\\/\\/schemas.xmlsoap.org\\/soap\\/envelope\\/\\" xmlns:ns1=\\"http:\\/\\/webservices.galileo.com\\"><SOAP-ENV:Body><ns1:SubmitTerminalTransaction><ns1:Token>ZvuhYvlsIuN8GB1+ylEeuRThGYp1BUBb5dik\\/qVCBTK7a0OVT\\/Wy0bGSsrh2g6vhLNSXMkn\\/VAmuqjceEMORyMB0vMb0bvaZULJYa92mekzOUTUOM9Y+4Wox2xT5tqMx<\\/ns1:Token><ns1:Request>*R<\\/ns1:Request><ns1:IntermediateResponse><\\/ns1:IntermediateResponse><\\/ns1:SubmitTerminalTransaction><\\/SOAP-ENV:Body><\\/SOAP-ENV:Envelope>"}
{"dt":1565084689,"dt_micro":"15650846890228000","hst":"ap01prtr.dyninno.net","msg":"XML RS:","obj":"<?xml version=\\"1.0\\" encoding=\\"UTF-8\\"?>\\n<soapenv:Envelope xmlns:soapenv=\\"http:\\/\\/schemas.xmlsoap.org\\/soap\\/envelope\\/\\" xmlns:xsd=\\"http:\\/\\/www.w3.org\\/2001\\/XMLSchema\\" xmlns:xsi=\\"http:\\/\\/www.w3.org\\/2001\\/XMLSchema-instance\\">\\n <soapenv:Body><SubmitTerminalTransactionResponse xmlns=\\"http:\\/\\/webservices.galileo.com\\"><SubmitTerminalTransactionResult USM=\\"false\\"> 1. UA 8844 U  20MAY LAXFRA HS1   310P #1050A O        E WE  1\\n         OPERATED BY DEUTSCHE LUFTHANSA AG\\n 2. UA 9132 U  21MAY FRABOM HS1   120P # 100A O        E TH  1\\n         OPERATED BY DEUTSCHE LUFTHANSA AG\\n 3. LH  757 S  25MAY BOMFRA HS1   255A   800A O        E MO  2\\n 4. LH  450 S  25MAY FRALAX HS1   210P   450P O        E MO  2\\n** FILED FARE DATA EXISTS **           &gt;*FF;\\n&gt;&lt;<\\/SubmitTerminalTransactionResult><\\/SubmitTerminalTransactionResponse> <\\/soapenv:Body>\\n<\\/soapenv:Envelope>"}
{"dt":1565084689,"dt_micro":"15650846890241000","hst":"ap01prtr.dyninno.net","msg":"ERROR: HTTP RQ was not satisfied 400","obj":"{\\n    \\"message\\": \\"Last pricing command FQP1.2*INF\\/S1.2 does not cover some itinerary segments: 3,4\\",\\n    \\"httpStatusCode\\": 400,\\n    \\"isOk\\": undefined,\\n    \\"data\\": undefined,\\n    \\"errorClass\\": \\"Error\\",\\n    \\"stack\\": [\\n        \\"Error: Last pricing command FQP1.2*INF\\/S1.2 does not cover some itinerary segments: 3,4\\",\\n        \\"    at makeExc (\\/export\\/storage0\\/www\\/gds-direct-plus.asaptickets.com\\/node_modules\\/klesun-node-tools\\/src\\/Rej.js:15:10)\\",\\n        \\"    at Object.makeRejection [as BadRequest] (\\/export\\/storage0\\/www\\/gds-direct-plus.asaptickets.com\\/node_modules\\/klesun-node-tools\\/src\\/Rej.js:27:13)\\",\\n        \\"    at ImportPqGalileoAction.collectPricingCmds (\\/export\\/storage0\\/www\\/gds-direct-plus.asaptickets.com\\/backend\\/Transpiled\\/Rbs\\/GdsDirect\\/Actions\\/Galileo\\/ImportPqGalileoAction.js:233:10)\\",\\n        \\"    at process._tickCallback (internal\\/process\\/next_tick.js:68:7)\\"\\n    ].join(\\"\\\\n\\")\\n}"}`;

    let parseJs = (jsCode) => {
        try {
            return eval('(' + jsCode + ')');
        } catch (syntaxError) {
            let lines = jsCode.split('\n').filter(l => l.trim());
            if (lines.length > 0) {
                // try to parse as json object lines, our fluent logger
                return lines.map(l => JSON.parse(l));
            } else {
                throw syntaxError;
            }
        }
    };

    let findClosingParen = (printRText) => {
        //return printRText.indexOf(')');
        let depth = 0;
        for (let i = 0; i < printRText.length; ++i) {
            let ch = printRText[i];
            if (ch === '(') {
                ++depth;
            } else if (ch === ')') {
                --depth;
            }
            if (depth < 0) {
                return i;
            }
        }
        return -1;
    };

    let prettyPrintParentheses = (text) => {
        let level = 0;
        let output = '';
        for (let i = 0; i < text.length; ++i) {
            let prev = text[i - 1];
            let ch = text[i];
            let next = text[i + 1];
            if (ch === '(' && next !== ')') {
                ++level;
                output += ch + '\n' + ' '.repeat(level);
            } else if (ch === ')' && prev !== '(') {
                --level;
                output += '\n' + ' '.repeat(level) + ch + '\n' + ' '.repeat(level);
            } else {
                output += ch;
            }
        }
        return output;
    };

    let parseHttpQuery = query => {
        let result = {};
        for (let entry of query.split('&')) {
            let [k,v] = entry.split('=');
            k = decodeURIComponent(k);
            v = decodeURIComponent(v.replace(/\+/g, '%20'));
            let [_, varName, hasSub, subKeyStr] = k.match(/^(.+?)(?:(\[)(.*)\]|)$/);
            let keys = hasSub ? subKeyStr.split('][') : [];
            keys.unshift(varName);
            let destination = result;
            for (let i = 0; i < keys.length; ++i) {
                let key = keys[i];
                let next = keys[i + 1];
                let def = next === '' ? [] : {};
                if (key === '') {
                    // array
                    key = destination.length;
                    destination.push(def);
                } else {
                    // object key
                    destination[key] = destination[key] || def;
                }
                if (next === '') {
                    destination = destination[key];
                } else if (next) {
                    destination = destination[key];
                } else {
                    destination[key] = v;
                }
            }
        }
        return result;
    };

    let buttons = [
        {
            name: 'http query to json',
            implementation: query => Tls.jsExport(parseHttpQuery(query), null, getInlineLimit()),
            sample: 'rId=7488984&flightOptionId=30309597&apolloPcc=1&currency=1&customerRemarks=&internalRemarks=&msg=++2++HF3513+B+22DEC+6+EWRABJ+TK1++1155P+240P+23DEC++E++HF%2FPP2QJI%0D%0A++3++HF+532+B+23DEC+7+ABJLOS+HK1+++100P+400P+23DEC++E++HF%2FPP2QJI%0D%0A++4++ET1421+T+21JAN+1+LOSABJ+HK1++1010A1050A+21JAN++E++ET%2FMHNMVE%0D%0A++5++HF3512+V+21JAN+1+ABJEWR+TK1+++215P+900P+21JAN++E++HF%2FPP2QJI%0D%0A&passengers%5B%5D=105464471&quote%5Bexchange%5D=on&exchange%5Badult%5D%5BairlinePenalty%5D=250&exchange%5Badult%5D%5BnoShowFee%5D=&exchange%5Badult%5D%5BitnProcessingFee%5D=250&exchange%5Badult%5D%5BfareDiff%5D=0&quote%5Brefund%5D=on&refund%5Badult%5D%5BticketPrice%5D=0&refund%5Badult%5D%5BairlinePenalty%5D=250&refund%5Badult%5D%5BnoShowFee%5D=&refund%5Badult%5D%5BitnProcessingFee%5D=250&refund%5Badult%5D%5BrecalledCommissions%5D=0&refund%5Badult%5D%5BnonRefundableServiceFee%5D=&csDraftId=undefined',
            language: 'ace/mode/javascript',
        },
        {
            name: 'Prettify json',
            implementation: jsCode => Tls.jsExport(parseJs(jsCode), null, getInlineLimit()),
            sample: '["aaa", "bbb", "ccc"].join("\\n")',
            language: 'ace/mode/javascript',
        },
        {
            name: 'Prettify XML',
            implementation: inlineXml => Tls.prettifyXml(inlineXml),
            sample: '["aaa", "bbb", "ccc"].join("\\n")',
            language: 'ace/mode/html',
        },
        // php stuff
        {
            name: 'var_export to json',
            implementation: phpCode => Tls.jsExport(VarExportParser.parse(phpCode), null, getInlineLimit()),
            sample: varExportExample,
            language: 'ace/mode/javascript',
        },
        {
            name: 'json to var_export',
            implementation: jsCode => Tls.varExport(parseJs(jsCode), null, '    ', getInlineLimit()),
            sample: '["aaa", "bbb", "ccc"].join("\\n")',
            language: 'ace/mode/php',
        },
        {
            name: 'print_r parser',
            implementation: printRText => {
                let parsed = parsePrintRValue(printRText);
                return Tls.jsExport(parsed, null, getInlineLimit());
            },
            sample: printRExample,
            language: 'ace/mode/javascript',
        },
        // SQL stuff
        {
            name: 'SQL select -> JSON',
            implementation: sqlSelectToJson,
            sample: someSqlSelect,
            language: 'ace/mode/javascript',
        },
        {
            name: 'SQL \\G to var_export',
            implementation: text => Tls.varExport(parseSqlSelectG(text), null, '    ', getInlineLimit()),
            sample: someSqlSelectG,
            language: 'ace/mode/php',
        },
        {
            name: 'SQL tabs to var_export',
            implementation: csvTabs => Tls.varExport(parseCsvTabs(csvTabs), null, '    ', getInlineLimit()),
            sample: '',
            language: 'ace/mode/php',
        },
        {
            name: 'To CSV',
            implementation: jsonText => jsonToCsv(jsonText),
            sample: '',
            language: 'ace/mode/javascript',
        },
        {
            name: 'From CSV (Tab)',
            implementation: csvText => csvToJson(csvText, '\t'),
            sample: '',
            language: 'ace/mode/javascript',
        },
        {
            name: 'To JSON CSV',
            implementation: jsonText => jsonToCsv(jsonText, true),
            sample: '',
            language: 'ace/mode/php',
        },
        {
            name: 'To fixed width unicode',
            implementation: text => {
                let result = '';
                // if you specify them in string literals, these characters get replaced
                // with gibberish, possibly because they are in a <script/> tag
                let mapping = fixedWidthCharMapping;
                for (let i = 0; i < text.length; ++i) {
                    let char = text[i];
                    if (char in mapping) {
                        result += String.fromCharCode(mapping[char]);
                    } else {
                        result += char;
                    }
                }
                return result;
            },
            sample: '',
            language: 'ace/mode/php',
        },
        {
            name: 'Text -> [...].join(\\n) (")',
            implementation: textToWrappedLinesDoubleQuoted,
            sample: someMultilineText,
            language: 'ace/mode/php',
        },
        {
            name: "Text -> [...].join(\\n) (')",
            implementation: textToWrappedLinesSingleQuoted,
            sample: someMultilineText,
            language: 'ace/mode/php',
        },
        {
            name: '<- Undo',
            implementation: wrappingCode =>
                    applyToEachLine(/^( *)'(.*?)'[,\.;].*$/, '$1$2', wrappingCode),
            sample: someWrappingMultiLineCode,
            language: 'ace/mode/plain_text',
        },
        // misc
        {
            name: 'Pretty-Print Parentheses',
            implementation: jsonText => prettyPrintParentheses(jsonText),
            sample: '',
            language: 'ace/mode/plain_text',
        },
        {
            name: 'Put to "currentData" variable',
            implementation: jsCode => {
                window.currentData = parseJs(jsCode);
                return jsCode;
            },
            sample: '{a:5,b:6}',
            language: 'ace/mode/javascript',
        },
        {
            name: 'Put to "currentData" variable from clipboard',
            implementation: () => {
                navigator.clipboard.readText()
                    .then(text => {
                        window.currentData = text;
                    })
                    .catch(err => {
                        console.error('Failed to read clipboard contents: ', err);
                    });
            },
            language: 'ace/mode/javascript',
        },
    ];

    let editor = ace.edit('describeInput');
    editor.getSession().setMode("ace/mode/javascript");
    let buttonsCont = document.getElementById('buttonsCont');

    let makeCallback = (buttonInfo) => () => {
        if (!editor.getValue() && buttonInfo.sample) {
            editor.setValue(buttonInfo.sample);
        } else {
            editor.getSession().setMode({path: buttonInfo.language, inline: true});
            editor.setValue(buttonInfo.implementation(editor.getValue()) + '\n');
        }
    };

    for (let buttonInfo of buttons) {
        let btnEl = document.createElement('button');
        btnEl.innerHTML = buttonInfo.name;
        btnEl.onclick = makeCallback(buttonInfo);
        buttonsCont.appendChild(btnEl);
    }

    let xmlToArrBtnEl = document.createElement('button');
    xmlToArrBtnEl.innerHTML = 'server-side: xmlToArr';
    xmlToArrBtnEl.onclick = function(e) {
        let xml = editor.getValue().trim();
        editor.getSession().setMode({path: 'ace/mode/php', inline: true});
        Tls.xmlToArr(xml).then =
            (parsed) => editor.setValue(Tls.jsExport(parsed, null, getInlineLimit()));
    };
    buttonsCont.appendChild(xmlToArrBtnEl);

    if (hashData.dataset === 'varExportExample') {
        editor.setValue(varExportExample);
    }
</script>
</body>

<style>
    #describeInput {
        font-size: 10px;
        float: left;
        width: 900px;
        resize: horizontal;
        height: 600px;
        border: solid grey 4px;
    }
    button {
        display: block;
    }
</style>
